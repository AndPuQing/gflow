name: PyPI Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

permissions:
    contents: read

jobs:
    linux:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                target:
                    # x86_64 GNU libc (most common)
                    - x86_64-unknown-linux-gnu
                    # x86_64 MUSL (static linking, Alpine Linux)
                    - x86_64-unknown-linux-musl
                    # ARM64 GNU libc (Raspberry Pi 4, AWS Graviton, etc.)
                    - aarch64-unknown-linux-gnu
                    # ARM64 MUSL (static linking)
                    - aarch64-unknown-linux-musl
        steps:
            - uses: actions/checkout@v6

            - name: Set up Python
              uses: actions/setup-python@v6
              with:
                  python-version: "3.14"

            - name: Install maturin
              run: pip install maturin

            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.target }}
                  args: --release --out dist
                  sccache: "true"
                  manylinux: auto
                  # Use musllinux for MUSL targets
                  container: ${{ contains(matrix.target, 'musl') && 'musllinux_1_2' || 'auto' }}

            - name: Upload wheels
              uses: actions/upload-artifact@v6
              with:
                  name: wheels-linux-${{ matrix.target }}
                  path: dist

    publish:
        name: Publish to PyPI
        runs-on: ubuntu-latest
        needs: [linux]
        if: startsWith(github.ref, 'refs/tags/')
        permissions:
            id-token: write # Required for trusted publishing
        environment:
            name: pypi
            url: https://pypi.org/p/runqd
        steps:
            - uses: actions/download-artifact@v7
              with:
                  pattern: wheels-*
                  path: dist
                  merge-multiple: true

            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist/
